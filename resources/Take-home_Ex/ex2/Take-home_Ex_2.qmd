---
title: "Take-Home Exercise 2: Application of Geospatial Analysis Methods to Discover Thailand Drug Abuse at the Province Level"
author: "William"
date: "September 23, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  freeze: true
---

# Background

Nothing for now.

# Terms

-   Thailand administrative level 0 (country): **admin0**,

-   1 (province): **admin1**

-   2 (district): **admin2**

-   3 (sub-district, tambon): **admin3**

For the purposes of this exercise I will be dealing with **admin1** only (province-level).

# Objectives

# R Packages used

-   sf

-   tidyverse

-   [**readxl**](https://readxl.tidyverse.org/): since both datasets are in xls/xlsx format

-   skimr

-   sfdep

-   tmap

-   fitdist: finding out distribution type to match to match tmap style

```{r}
pacman::p_load(sf,tidyverse,skimr,readxl,sfdep,tmap,fitdistrplus)
```

# Data

::: panel-tabset
## \[.csv\] Thailand Drug Offenses 2017-2022

[**Source**](https://www.kaggle.com/datasets/thaweewatboy/thailand-drug-offenses-2017-2022)

**Metadata**

-   fiscal_year: recorded year

-   types_of_drug_offenses: category of offense

-   no_cases: total records for combination of year, drug offense type and province

-   province_th: province name in thai (**drop**)

-   province_en

**Import**

```{r}
thai_drug_offences_sf <- read_csv('data/aspatial/thai_drug_offenses_2017_2022.csv')
```

```{r}

str(thai_drug_offences_sf)
```

```{r}

summ_table <- skim(thai_drug_offences_sf) %>% as.data.frame()
summ_table
```

> -   No missing data
>
> -   Date range is indeed 2017 to 2022
>
> -   16 types of drug offenses (check unique values)
>
> -   summary statistics of overall **`no_cases`** seem to indicate **right-skew**

```{r}

thai_no_case <- summ_table %>% filter(skim_variable == 'no_cases') %>% dplyr::select(c(10:16))
thai_no_case
```

> Might need to view by offense type to see offense-specific distributions

Identify the unique values for each categorical column

```{r}

unique(thai_drug_offences_sf$fiscal_year)
```

```{r}
offense_type <- unique(thai_drug_offences_sf$types_of_drug_offenses)
offense_type
```

**Cleaning**

Remove thai labels

```{r}
thai_drug_offences_sf <- thai_drug_offences_sf %>% dplyr::select(1,2,3,5)
```

## \[.shp\] Thailand - Subnational Admin. Boundaries

[**Source**](https://data.humdata.org/dataset/d24bdc45-eb4c-4e3d-8b16-44db02667c27/resource/d0c722ff-6939-4423-ac0d-6501830b1759/download/tha_adm_rtsd_itos_20210121_shp.zip)

**Import**

```{r}
thai_admin1_sf <- st_read(
  dsn = 'data/geospatial/tha_adm_rtsd_itos_20210121_shp/',
  layer ='tha_admbnda_adm1_rtsd_20220121')
```

```{r}

glimpse(thai_admin1_sf)
```

**Extracting Columns**

Lots of completely missing fields and repetition across the columns.

```{r}
thai_admin1_sf <- thai_admin1_sf %>% dplyr::select(1:3,5)
thai_admin1_sf
```

```{r}

any(duplicated(thai_admin1_sf))
```
:::

## Aggregating by Province

### Relational Join

```{r}
set.seed(69)
```

```{r}
#| eval: false
province_drug_offences <- thai_drug_offences_sf %>% 
  group_by(province_en) %>%
  summarize(total_cases = sum(no_cases), .groups = 'drop')
head(province_drug_offences)
```

```{r}
#| eval: false
combined_prepped_drug_offences_ <- left_join(province_drug_offences, thai_admin1_sf,by = c('province_en'='ADM1_EN')) %>% st_as_sf()
glimpse(combined_prepped_drug_offences_)
```

```{r}
#| eval: false
tmap_mode('plot')

tm_shape(combined_prepped_drug_offences_)+
  tm_polygons() +
  tm_fill(alpha = .5,col = combined_prepped_drug_offences_$total_cases)
  tm_text(combined_prepped_drug_offences_$province_en)
```

### Landmine

This is where I encountered the first landmine of sorts. The above code results in:

``` r
Error in `$<-`:
! Assigned data `as.numeric(...)` must be compatible with existing data.
✖ Existing data has 77 rows.
✖ Assigned data has 75 rows.
ℹ Only vectors of size 1 are recycled.
Caused by error in `vectbl_recycle_rhs_rows()`:
! Can't recycle input of size 75 to size 77.
```

So I went to re-check the left-joined table `prepped_drug_offences` . I realised for the "buogkan" and "Loburi" rows, besides the 'total_cases' field, the rest of the fields were empty.

Seeing how suspiciously "buogkan" looks like a typo, I went to Google both "buogkan" and "Loburi" along with Thailand. Sure enough, the suggested words of "buogkan" and "Loburi" turned out to be **"Bueng Kan" and "Lop buri"** respectively.

Turned out the **Thailand Drug Offenses** **had the 2 erroneous province names**, while the shapefiles' province labels checked out.

I will have to do manual replacements for all affected fields in `thai_drug_offences_sf`

### Fixing Mispelled Province Names

Check before

```{r}

unique(thai_drug_offences_sf$province_en)[6]
unique(thai_drug_offences_sf$province_en)[30]
```

Rename

```{r}
thai_drug_offences_sf$province_en[which(thai_drug_offences_sf$province_en == "Loburi")] <- 'Lop buri'
thai_drug_offences_sf$province_en[which(thai_drug_offences_sf$province_en == "buogkan")] <- 'Bueng Kan'
```

Check fix

```{r}

unique(thai_drug_offences_sf$province_en)[6]
unique(thai_drug_offences_sf$province_en)[30]
```

That should resolve the landmine.

Separating suspected cases using `grepl()`

```{r}
# suspected
suspected_offenses_sf <- thai_drug_offences_sf %>% filter(grepl("suspects", types_of_drug_offenses))
```

```{r}
# actual
offenses_sf <- thai_drug_offences_sf %>% filter(!grepl("suspects", types_of_drug_offenses))
```

### \[Again\] Relational Join

```{r}
combined_offenses_sf <- left_join(
  (
    offenses_sf %>% 
      mutate(province_en = toupper(province_en)) %>%
      group_by(province_en) %>%
      summarize(total_cases = sum(no_cases), .groups = 'drop')),
  
  (
    thai_admin1_sf %>% 
      mutate(
        ADM1_EN = toupper(ADM1_EN),
        ADM1_PCODE = substr(ADM1_PCODE, 3, nchar(ADM1_PCODE)))),
  
  by = c('province_en'='ADM1_EN')) %>% 
  st_as_sf()

str(combined_offenses_sf)
```

```{r}
combined_suspected_offenses_sf <- left_join(
  (
    suspected_offenses_sf %>% 
      mutate(province_en = toupper(province_en)) %>%
      group_by(province_en) %>%
      summarize(total_cases = sum(no_cases), .groups = 'drop')),
  
  (
    thai_admin1_sf %>% 
      mutate(
        ADM1_EN = toupper(ADM1_EN),
        ADM1_PCODE = substr(ADM1_PCODE, 3, nchar(ADM1_PCODE)))),
  
  by = c('province_en'='ADM1_EN')) %>% 
  st_as_sf()

str(combined_suspected_offenses_sf)
```

### Distribution of `no_cases`

::: panel-tabset
#### Big Picture

Overall Visualisations using qtm() and tmap_arrange()

```{r}
basemap <- tm_shape(combined_offenses_sf) + tm_polygons() + tm_text("ADM1_PCODE",size = 0.4)
offenses <- qtm(combined_offenses_sf,"total_cases")
suspects <- qtm(combined_suspected_offenses_sf,"total_cases")
tmap_arrange(suspects, basemap, offenses, asp=1, ncol=3)
```

Overall Distributions

```{r}
par(mfrow=c(1,2))
plot(offenses_sf$no_cases)
plot(suspected_offenses_sf$no_cases)
```

```{r}
plot(fitdist(offenses_sf$no_cases, 'norm'))
```

```{r}
plot(fitdist(suspected_offenses_sf$no_cases, 'norm'))
```

#### Aggregated Cases by Province across 2017-2022

```{r}
par(mfrow=c(1,2))
plot(combined_offenses_sf$total_cases)
plot(combined_suspected_offenses_sf$total_cases)
```

```{r}
plot(fitdist(combined_offenses_sf$total_cases, 'norm'))
```

```{r}
plot(fitdist(combined_suspected_offenses_sf$total_cases, 'norm'))
```
:::

#### 

> **Conclusions: Right Skewed, heavy right tail, outliers present; Actual and Suspected cases follow the similar distribution**
>
> Hence, to visualise the continuous variable `total_cases` , I am goin to experiment with:
>
> -   `quantile`
>
> -   `log10`
>
> -   `order`
>
> <!-- -->
>
> -   `headtails`
>
> -   `log10_pretty`
>
> -   `cont`

### Visualise actual cases

> [Visual styling](https://r-tmap.github.io/tmap-book/visual-variables.html)

```{r}
tmap_mode('plot')
```

::: panel-tabset
#### style = "quantile"

<details>

<summary>Reveal Code</summary>

```{r}
offenses_qt <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "quantile",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 0.666
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_qt <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "quantile",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 0.666
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_qt, suspected_qt, asp=1, ncol=2)
```

</details>

#### style = "log10"

<details>

<summary>Reveal Code</summary>

```{r}

offenses_log <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "log10",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_log <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "log10",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_log, suspected_log, asp=1, ncol=2)
```

</details>

#### style = "order"

<details>

<summary>Reveal Code</summary>

```{r}

offenses_odr <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "order",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_odr <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "order",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_odr, suspected_odr, asp=1, ncol=2)
```

</details>

#### style = 'headtails'

<details>

<summary>Reveal Code</summary>

```{r}

offenses_ht <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "headtails",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_ht <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "headtails",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_ht, suspected_ht, asp=1, ncol=2)
```

</details>

#### style = 'log10_pretty'

<details>

<summary>Reveal Code</summary>

```{r}

offenses_lgprty <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "log10_pretty",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_lgprty <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "log10_pretty",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_lgprty, suspected_lgprty, asp=1, ncol=2)
```

</details>

#### style = 'cont'

<details>

<summary>Reveal Code</summary>

```{r}

offenses_cont <- tm_shape(combined_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "cont",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

suspected_cont <- tm_shape(combined_suspected_offenses_sf) +
  tm_fill(
    col = "total_cases",
    palette = "-RdYlGn",
    style = "cont",    # Use quantiles to emphasize hotspots
    border.col = "white",
    lwd = 0.666,             # Adjust line width of province borders
  ) +
  tm_text(
    "ADM1_PCODE",    # Province NUMERIC code
    size = "total_cases",  # proportional symbols
    col = "black",
    # auto.placement = TRUE,
    shadow = TRUE
  ) +
  
  tm_borders(lwd = 0.666) +  # Border thickness
  tm_compass(type="8star", size = 1.666) +
  tm_scale_bar(width = 0.156, position = c("right", "bottom"))  +
  tm_grid(lwd = 0.1, alpha = 0.2) +
  
  tm_layout(
    legend.outside = TRUE, 
    frame = FALSE,
    main.title = "Thailand Drug Suspected Offenses (2017-2022)",
    main.title.size = 1.0
  ) +
  tm_legend(position = c("right", "bottom")) # Legend Position

tmap_arrange(offenses_cont, suspected_cont, asp=1, ncol=2)
```

</details>
:::

> `'log10'` style had the best visualisation of the distribution drug offenses in terms of **contrast** between 'hot' and 'cold' spots and overall aesthetics.

## Aggregating by Time & Province (Same as on Prof's site)

### Prepare data

#### Relational Join

```{r}
offences_sf_joined <- left_join(
    (offenses_sf %>% 
            mutate(province_en = toupper(province_en)) %>% group_by(fiscal_year)),
    (thai_admin1_sf %>%
            mutate(ADM1_EN = toupper(ADM1_EN), ADM1_PCODE = substr(ADM1_PCODE, 3, nchar(ADM1_PCODE)))),
    by = c('province_en'='ADM1_EN')) %>%
    st_as_sf()

suspected_offenses_sf_joined <- left_join(
    (suspected_offenses_sf %>% 
            mutate(province_en = toupper(province_en)) %>% group_by(fiscal_year)),
    (thai_admin1_sf %>%
            mutate(ADM1_EN = toupper(ADM1_EN), ADM1_PCODE = substr(ADM1_PCODE, 3, nchar(ADM1_PCODE)))),
    by = c('province_en'='ADM1_EN')) %>%
    st_as_sf()
```

#### Modify

```{r}
offences_sf_by_province_year <- offences_sf_joined %>% 
    group_by(fiscal_year,province_en,ADM1_PCODE, geometry) %>%
    summarise(total_cases = sum(no_cases, na.rm = TRUE), .groups = "drop")

suspected_offences_sf_by_province_year <- suspected_offenses_sf_joined %>% 
    group_by(fiscal_year,province_en,ADM1_PCODE, geometry) %>%
    summarise(total_cases = sum(no_cases, na.rm = TRUE), .groups = "drop")
```

> `.groups = "drop"` avoids creating unnecessary group structure

### Check

```{r}
glimpse(offences_sf_by_province_year)
```

```{r}
glimpse(suspected_offences_sf_by_province_year)
```

### Visualise using `tmap`

As previously plotted, the distribution of drug offenses in Thailand (across time periods and within province areas) is characteristic of a **right-skewed distribution** or **heavy-tailed** distribution. Hence, a **logarithmic scale** or a **Jenks Natural Breaks** method would be suitable to handle the skewness and emphasize meaningful breaks in the data.

#### Log

<details>

<summary>Reveal Code</summary>

```{r}
tm_shape(offences_sf_by_province_year) +
  tm_fill(
    col = "total_cases",
    palette = "Blues",       # Use a blue color palette similar to the image
    style = "log10",      # Adjust based on the distribution of your data
    n = 5,                   # Define number of bins for colors
    title = "Drug use cases"
  ) +
  tm_borders() +
  tm_facets(by = "fiscal_year", nrow = 2, ncol = 3) +  # Facet by year, 2 rows and 3 columns
  tm_layout(
    title = "Drug use cases by year",               # Title for the entire plot
    legend.position = c("right", "bottom"),         # Position the legend on the right
    panel.label.size = 1.333,                         # Adjust the size of the year labels
    legend.title.size = .666,                        # Customize the size of the legend title
    legend.text.size = .666                          # Customize the size of the legend text
  )
```

```{r}
tm_shape(suspected_offences_sf_by_province_year) +
  tm_fill(
    col = "total_cases",
    palette = "Blues",       # Use a blue color palette similar to the image
    style = "log10",      # Adjust based on the distribution of your data
    n = 5,                   # Define number of bins for colors
    title = "Suspected Drug uses"
  ) +
  tm_borders() +
  tm_facets(by = "fiscal_year", nrow = 2, ncol = 3) +  # Facet by year, 2 rows and 3 columns
  tm_layout(
    title = "Suspected Drug uses by year",               # Title for the entire plot
    legend.position = c("right", "bottom"),         # Position the legend on the right
    panel.label.size = 1.333,                         # Adjust the size of the year labels
    legend.title.size = .666,                        # Customize the size of the legend title
    legend.text.size = .666                          # Customize the size of the legend text
  )
```

</details>

#### Jenks

<details>

<summary>Reveal Code</summary>

```{r}
# Create the faceted map
tm_shape(offences_sf_by_province_year) +
  tm_fill(
    col = "total_cases",
    palette = "Blues",       # Use a blue color palette similar to the image
    style = "jenks",      # Adjust based on the distribution of your data
    n = 5,                   # Define number of bins for colors
    title = "Drug use cases"
  ) +
  tm_borders() +
  tm_facets(by = "fiscal_year", nrow = 2, ncol = 3) +  # Facet by year, 2 rows and 3 columns
  tm_layout(
    title = "Drug use cases by year",               # Title for the entire plot
    legend.position = c("right", "bottom"),         # Position the legend on the right
    panel.label.size = 1.333,                         # Adjust the size of the year labels
    legend.title.size = .666,                        # Customize the size of the legend title
    legend.text.size = .666                          # Customize the size of the legend text
  )

tm_shape(suspected_offences_sf_by_province_year) +
  tm_fill(
    col = "total_cases",
    palette = "Blues",       # Use a blue color palette similar to the image
    style = "jenks",      # Adjust based on the distribution of your data
    n = 5,                   # Define number of bins for colors
    title = "Suspected Drug uses"
  ) +
  tm_borders() +
  tm_facets(by = "fiscal_year", nrow = 2, ncol = 3) +  # Facet by year, 2 rows and 3 columns
  tm_layout(
    title = "Suspected Drug uses by year",               # Title for the entire plot
    legend.position = c("right", "bottom"),         # Position the legend on the right
    panel.label.size = 1.333,                         # Adjust the size of the year labels
    legend.title.size = .666,                        # Customize the size of the legend title
    legend.text.size = .666                          # Customize the size of the legend text
  )
```

</details>

> Jenks has better contrast between hot and cold spots overall compared to the logarithmic method

### Visualising Drug Abuse Indicators

Prepare layers

```{r}
# drugthai_drug_offences_sf_by_joined %>% filter(types_of_drug_offenses=='drug_use_cases')
```

### \[FUTURE\] Comparing with Population Data

\<TODO\>

```{r}
write_rds(offences_sf_by_province_year, 'data/rds/offences_sf_by_province_year.rds')
write_rds(suspected_offences_sf_by_province_year, 'data/rds/suspected_offences_sf_by_province_year.rds')
```

```{r}
offences_sf_by_province_year = read_rds('data/rds/offences_sf_by_province_year.rds')
suspected_offences_sf_by_province_year = read_rds('data/rds/suspected_offences_sf_by_province_year.rds')
```
