---
title: "ICE 2: "
author: "William"
date: "August 26, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  freeze: true
---

# Load packages

```{r}
pacman::p_load(tidyverse,sf,ggstatsplot,tmap)
```

# Import data

### [**Master Plan 2014 Subzone Boundary (Web)**](https://beta.data.gov.sg/datasets?query=Master+Plan+2014+Subzone+Boundary+%28Web%29&resultId=d_5cb80a95445f236737f6bc2bfe5f159d)

##### **SHP**

```{r }
mpsz14_shp <- st_read(dsn = 'data/geospatial/', layer = 'MP14_SUBZONE_WEB_PL')
# layer means sf will search for the engine(?)
# layer wont need extension because it knows to seek for a shapefile
#'<-' or '=' works on windows+macOS
```

> Note: R is a OOP enabled language, sf being the object class

**Examine the data**

```{r eval=FALSE}
View(mpsz14_shp)
```

##### **KML**

```{r eval=FALSE}
mpsz14_kml = st_read('data/geospatial/MasterPlan2014SubzoneBoundaryWebKML.kml')
# supposed to trigger a error message saying its unsupported / corrupted
```

**`MasterPlan2014SubzoneBoundaryWebKML.kml` from data.gov.sg is apparently corrupted.**

**This is a quick fix:**

```{r warning=FALSE}
st_write(mpsz14_shp, 'data/geospatial/MP14_SUBZONE_WEB_PL.kml', delete_dsn = TRUE)
```

### **Master Plan 2019 Subzone Boundary (No sea)**

##### **kml**

```{r}
mpsz19_kml = st_read('data/geospatial/MasterPlan2019SubzoneBoundaryNoSeaKML.kml')
```

##### **SHP** (from ice1 in elearn)

```{r}
mpsz19_shp <- st_read(dsn = 'data/MPSZ-2019/', layer = 'MPSZ-2019')
```

##### **geojson**

```{r}
mpsz19_geojson <- st_read('data/geospatial/MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson')
```

> Note: geojson format is very messy because the data is buried under html tags so lines of code is needed to extract; while in the kml / shp formats the data is readily accessible

> Note: under 'geometry' if the values tend to be large, its because its in PCS (measure in meters)

### Singapore Residents by Planning Area / Subzone, Age Group, Sex and Floor Area of Residence 2023

> Note: use the .csv file

```{r}
popdata2023 = read_csv('data/respopagesexfa2023.csv')
```

# Data Wrangling

**Prepare a data frame using the population data**

```{r}
popdata2023 = popdata2023 %>% 
  group_by(PA,SZ,AG) %>% 
  summarise(POP=sum(Pop)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = AG,values_from = POP)
```

> pivot_wider() transposes the data table structure for easier function application

**Examine the data structure**

```{r}
str(popdata2023)
```

> Note: age ranges are not in sequential order

```{r}
colnames(popdata2023)
```

> Note: index starts from 1

**Fix the data table (override the previous)**

```{r}
popdata2023 = popdata2023 %>% 
  # CALCULATING AGE GROUP TOTALS
  mutate(`YOUNG`=rowSums(.[3:6])+rowSums(.[14])) %>%                # CREATES new col 'YOUNG'
  mutate(`ECONOMY ACTIVE`=rowSums(.[7:13])+rowSums(.[15])) %>%   # CREATES new col `ECONOMY ACTIVE`
  mutate(`AGED`=rowSums(.[16:21])) %>%                              # CREATES new col `AGED`
  mutate(`TOTAL`=rowSums(.[3:21])) %>%                              # CREATES new col `TOTAL`
  mutate(`DEPENDENCY` = (`YOUNG` + `AGED`)/`ECONOMY ACTIVE`) %>%   # CREATES new col `DEPENDENCY` to calculate dependency ratio
  select(`PA`, `SZ`, `YOUNG`, `ECONOMY ACTIVE`, `AGED`, `TOTAL`, `DEPENDENCY`) # determines column order and contents in OUTPUT DATASET

```

**Because R is case sensitive, convert everything into the same upper/lowercase in all the datasets**

```{r}
popdata2023 = popdata2023 %>% 
  mutate_at(.vars = vars(PA,SZ),.funs = list(toupper))
```

**Combine**

```{r}
popdata2023 = left_join(popdata2023,mpsz19_shp, by = c('SZ'='SUBZONE_N'))
```

> Note: In the c() function, the column names' positions correspond to which data table is the left table

# Transforming Coordinate System

```{r}
mpsz19_shp = st_read(dsn = 'data/MPSZ-2019/', layer = 'MPSZ-2019') %>% # piping caches for next operation, saving memory
  st_transform(crs = 3414)
```

```{r}
preschool = st_read('data/PreSchoolsLocation.kml') %>% 
  st_transform(crs = 3414)
```

**Checking CRS**

```{r}
st_crs(mpsz19_shp)
```
